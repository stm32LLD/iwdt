// Copyright (c) 2023 Ziga Miklosic
// All Rights Reserved
////////////////////////////////////////////////////////////////////////////////
/**
*@file      iwdt.c
*@brief     Independent WDT LL drivers based on STM32 HAL library
*@author    Ziga Miklosic
*@email     ziga.miklosic@gmail.si
*@date      04.05.2023
*@version   V0.1.0
*/
////////////////////////////////////////////////////////////////////////////////
/*!
* @addtogroup IWDT
* @{ <!-- BEGIN GROUP -->
*/
////////////////////////////////////////////////////////////////////////////////

////////////////////////////////////////////////////////////////////////////////
// Includes
////////////////////////////////////////////////////////////////////////////////
#include <stdlib.h>
#include <stdint.h>
#include <stdbool.h>

#include "iwdt.h"
#include "../../iwdt_cfg.h"

////////////////////////////////////////////////////////////////////////////////
// Definitions
////////////////////////////////////////////////////////////////////////////////


/**
 *      LSI 32kHz RC Clock prescaler for IWDT downcount
 *
 *  Prescaler of 32 result in 1kHz down count frequency. Meaning
 *  one tick per 1 ms.
 */
#define IWDT_PRESCALER              ( IWDG_PRESCALER_32 )


////////////////////////////////////////////////////////////////////////////////
// Variables
////////////////////////////////////////////////////////////////////////////////

/**
 *  Initialization guard
 */
static bool gb_is_init = false;

/**
 *  Watchdog handler
 */
static IWDG_HandleTypeDef g_iwdt;


////////////////////////////////////////////////////////////////////////////////
// Function prototypes
////////////////////////////////////////////////////////////////////////////////


////////////////////////////////////////////////////////////////////////////////
// Functions
////////////////////////////////////////////////////////////////////////////////


////////////////////////////////////////////////////////////////////////////////
/**
* @} <!-- END GROUP -->
*/
////////////////////////////////////////////////////////////////////////////////

////////////////////////////////////////////////////////////////////////////////
/**
*@addtogroup IWDT_API
* @{ <!-- BEGIN GROUP -->
*
* 	Following function are part of Independent Watchdog API.
*/
////////////////////////////////////////////////////////////////////////////////

////////////////////////////////////////////////////////////////////////////////
/*!
* @brief        Independent Watchdog initialization
*
* @return       status - Status of operation
*/
////////////////////////////////////////////////////////////////////////////////
iwdt_status_t iwdt_init(void)
{
    iwdt_status_t status = eIWDT_OK;

    if ( false == gb_is_init )
    {
        // Configure IWDT
        g_iwdt.Instance         = IWDG;
        g_iwdt.Init.Prescaler   = IWDT_PRESCALER;
        g_iwdt.Init.Window      = 4095;                 // Window option is disabled
        g_iwdt.Init.Reload      = IWDT_CFG_PERIOD_MS;

        // Init done
        gb_is_init = true;
    }

    return status;
}

////////////////////////////////////////////////////////////////////////////////
/*!
* @brief        Start Independent Watchdog
*
* @return       status - Status of operation
*/
////////////////////////////////////////////////////////////////////////////////
iwdt_status_t iwdt_start(void)
{
    iwdt_status_t status = eIWDT_OK;

    IWDT_ASSERT( true == gb_is_init );

    if ( true == gb_is_init )
    {
        if ( HAL_OK != HAL_IWDG_Init( &g_iwdt ))
        {
            status = eIWDT_ERROR;
        }
    }
    else
    {
        status = eIWDT_ERROR;
    }

    return status;
}

////////////////////////////////////////////////////////////////////////////////
/*!
* @brief        Kick Independent Watchdog
*
* @return       status - Status of operation
*/
////////////////////////////////////////////////////////////////////////////////
iwdt_status_t iwdt_kick(void)
{
    iwdt_status_t status = eIWDT_OK;

    IWDT_ASSERT( true == gb_is_init );

    if ( true == gb_is_init )
    {
        HAL_IWDG_Refresh( &g_iwdt );
    }
    else
    {
        status = eIWDT_ERROR;
    }

    return status;
}


////////////////////////////////////////////////////////////////////////////////
/**
* @} <!-- END GROUP -->
*/
////////////////////////////////////////////////////////////////////////////////
